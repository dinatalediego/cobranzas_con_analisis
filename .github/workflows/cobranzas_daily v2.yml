name: cobranzas daily

on:
  workflow_dispatch:
  schedule:
    - cron: "0 13 * * *"  # 08:00 Peru (UTC-5) aprox; ajusta si quieres

jobs:
  cobranzas_daily:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate inputs (fail fast)
        run: |
          test -f data/inputs/pagos.xlsx || (echo "ERROR: falta data/inputs/pagos.xlsx" && exit 1)

      - name: Run pipeline (extract -> transform -> report)
        env:
          REDSHIFT_HOST: ${{ secrets.REDSHIFT_HOST }}
          REDSHIFT_PORT: ${{ secrets.REDSHIFT_PORT }}
          REDSHIFT_DB: ${{ secrets.REDSHIFT_DB }}
          REDSHIFT_USER: ${{ secrets.REDSHIFT_USER }}
          REDSHIFT_PASSWORD: ${{ secrets.REDSHIFT_PASSWORD }}

          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}

          EMAIL_TO_1: ${{ secrets.EMAIL_TO_1 }}
          EMAIL_FROM_NAME: ${{ secrets.EMAIL_FROM_NAME }}
        run: |
          python -m src.pipeline \
            --excel data/inputs/pagos.xlsx \
            --out artifacts \
            --snapshot

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cobranzas_artifacts
          path: artifacts

      - name: Prepare email body (multiline safe)
        run: |
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "Cobranzas daily ✅" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "Adjunto artifacts (ver Actions artifacts)." >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "Resumen:" >> $GITHUB_OUTPUT
          if [ -f artifacts/summary.md ]; then
            cat artifacts/summary.md >> $GITHUB_OUTPUT
          else
            echo "- (no summary.md encontrado)" >> $GITHUB_OUTPUT
          fi
          echo "EOF" >> $GITHUB_OUTPUT
        id: email

      - name: Send email via Gmail SMTP
        uses: hilarion5/send-mail@v1
        with:
          smtp-server: smtp.gmail.com
          smtp-port: 587
          smtp-secure: false
          from-email: ${{ secrets.SMTP_USERNAME }}
          to-email: ${{ secrets.EMAIL_TO_1 }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Cobranzas Daily — ${{ github.run_number }}"
          body: ${{ steps.email.outputs.body }}
